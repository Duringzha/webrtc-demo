(function(e){function n(n){for(var t,r,a=n[0],s=n[1],l=n[2],u=0,f=[];u<a.length;u++)r=a[u],Object.prototype.hasOwnProperty.call(c,r)&&c[r]&&f.push(c[r][0]),c[r]=0;for(t in s)Object.prototype.hasOwnProperty.call(s,t)&&(e[t]=s[t]);d&&d(n);while(f.length)f.shift()();return i.push.apply(i,l||[]),o()}function o(){for(var e,n=0;n<i.length;n++){for(var o=i[n],t=!0,a=1;a<o.length;a++){var s=o[a];0!==c[s]&&(t=!1)}t&&(i.splice(n--,1),e=r(r.s=o[0]))}return e}var t={},c={app:0},i=[];function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}r.m=e,r.c=t,r.d=function(e,n,o){r.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:o})},r.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,n){if(1&n&&(e=r(e)),8&n)return e;if(4&n&&"object"===typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(r.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var t in e)r.d(o,t,function(n){return e[n]}.bind(null,t));return o},r.n=function(e){var n=e&&e.__esModule?function(){return e["default"]}:function(){return e};return r.d(n,"a",n),n},r.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},r.p="/";var a=window["webpackJsonp"]=window["webpackJsonp"]||[],s=a.push.bind(a);a.push=n,a=a.slice();for(var l=0;l<a.length;l++)n(a[l]);var d=s;i.push([0,"chunk-vendors"]),o()})({0:function(e,n,o){e.exports=o("56d7")},"16d8":function(e,n,o){},"56d7":function(e,n,o){"use strict";o.r(n);o("e260"),o("e6cf"),o("cca6"),o("a79d");var t=o("2b0e"),c=function(){var e=this,n=e.$createElement,o=e._self._c||n;return o("div",{attrs:{id:"app"}},[o("webRtc")],1)},i=[],r=function(){var e=this,n=e.$createElement,o=e._self._c||n;return o("div",{staticClass:"main"},[e.userType?e._e():o("el-button",{attrs:{type:"primary"},on:{click:e._sendChatInvitation}},[e._v("开始")]),e.userType?o("el-button",{attrs:{type:"warning"},on:{click:e._endChatting}},[e._v("结束")]):e._e(),e.userType?o("el-button",{attrs:{type:"primary",plain:""},on:{click:e._camareCtrl}},[e._v(e._s("on"==e.camare?"关闭摄像头":"开启摄像头"))]):e._e(),e.userType?o("el-button",{attrs:{type:"primary",plain:""},on:{click:e._audioCtrl}},[e._v(e._s("on"==e.audio?"关闭麦克风":"开启麦克风"))]):e._e(),o("div",{staticClass:"video-wrap"},[o("div",{staticClass:"remoteVideoBox"},[o("video",{staticClass:"remoteVideo",attrs:{id:"remoteVideo",playsinline:"",autoplay:"",muted:""},domProps:{muted:!0}}),o("audio",{attrs:{autoplay:"",id:"remoteAudio"}}),o("i",{staticClass:"cameraIcon el-icon-video-camera"}),o("i",{staticClass:"audioIcon el-icon-microphone"})]),o("div",{staticClass:"localVideoBox"},[o("video",{staticClass:"localVideo",attrs:{id:"localVideo",playsinline:"",autoplay:"",muted:""},domProps:{muted:!0}}),o("i",{staticClass:"cameraIcon el-icon-video-camera",class:"on"==e.camare?"active":""}),o("i",{staticClass:"audioIcon el-icon-microphone",class:"on"==e.audio?"active":""})])])],1)},a=[],s=(o("d3b7"),o("25f0"),o("b85c")),l={data:function(){return{user_id:"",camare:"on",audio:"on",connector_id:null,offer:null,peerConnection:null,userType:""}},mounted:function(){var e=this;e.$nextTick((function(){e._renderChatRoom()}))},sockets:{connect:function(){console.log("socket connect")},chatInvitationEvent:function(e){var n=this;console.log(e),e.user_id!=n.user_id&&n.$confirm("用户："+e.user_id+"发起了视频聊天邀请，是否参加？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((function(){n.userType="consumer",n.$socket.emit("startMediaChat")})).catch((function(){n.userType="",n.$socket.emit("refuseInvitation",n.connector_id)}))},refuseInvitation:function(){this.$message("对方已拒绝邀请，视频聊天结束")},chatRoomCreateSuccess:function(){this.$message("对方已接受邀请，视频聊天开始"),this.$socket.emit("declare",{id:this.user_id,type:this.userType})},newProductor:function(e){var n=this;console.log("getRemoteConnector",e),console.log("getRemoteConnector",n.userType),"productor"!=n.userType&&(n.connector_id=e.id,n.peerConnection=new RTCPeerConnection(n.configuration,n.pcOptions),n.peerConnection.onicecandidate=function(e){e.candidate&&n.connector_id&&n.$socket.emit("icecandidate",{peer:n.connector_id,owner:n.user_id,candidate:e.candidate})},n.peerConnection.ontrack=function(e){console.log(0),n._setRemoteVideo(e)},console.log("getRemoteConnector createOffer"),n.peerConnection.createOffer({offerToReceiveVideo:!0,offerToReceiveAudio:!0}).then((function(e){n.offer=e,console.log("call_productor",n.connector_id),n.$socket.emit("call",{callee:n.connector_id,sdp:e})})))},newConsumer:function(e){var n=this;console.log(e),"consumer"!=n.userType&&(n.connector_id=e.id,n.peerConnection=new RTCPeerConnection(n.configuration,n.pcOptions),n.peerConnection.onicecandidate=function(e){e.candidate&&n.connector_id&&n.$socket.emit("icecandidate",{peer:n.connector_id,owner:n.user_id,candidate:e.candidate})},n.peerConnection.ontrack=function(e){console.log(0),n._setRemoteVideo(e)},console.log("getRemoteConnector createOffer"),n.peerConnection.createOffer({offerToReceiveVideo:!0,offerToReceiveAudio:!0}).then((function(e){n.offer=e,console.log("call_consumer",n.connector_id),n.$socket.emit("call",{callee:n.connector_id,sdp:e})})))},answer:function(e){var n=this;if(n.peerConnection.setLocalDescription(n.offer),n.connector_id==e.callee){var o=new RTCSessionDescription(e.sdp);n.peerConnection.setRemoteDescription(o).then((function(){console.log("get remote media success")})).catch((function(e){console.log("setRemoteDescription error",e)}))}},icecandidate:function(e){var n=this;n.connector_id=e.owner,console.log(n.connector_id);try{console.info("addIceCandidate ",e.candidate),n.peerConnection.addIceCandidate(e.candidate).then((function(){})).catch((function(e){return console.error(e)}))}catch(o){console.log(o)}},hangup:function(){console.log("scne 对方已退出视频聊天"),this.$message("对方已退出视频聊天"),this.userType="",this.peerConnection.close(),this.re_peerConnection.close(),this.peerConnection=null,this.re_peerConnection=null,this.$socket.emit("disconnect",1);var e,n=Object(s["a"])(this.local_stream.getTracks());try{for(n.s();!(e=n.n()).done;){var o=e.value;o.stop()}}catch(t){n.e(t)}finally{n.f()}},offer:function(e){var n=this;n.connector_id=e.caller,n.re_peerConnection=new RTCPeerConnection(n.configuration,n.pcOptions),n.re_peerConnection.onicecandidate=function(e){e.candidate&&n.connector_id&&n.$socket.emit("icecandidate",{peer:n.connector_id,owner:n.user_id,candidate:e.candidate})},n.re_peerConnection.onIceStateChange=function(e,n){e&&(console.log(" ICE state: ".concat(e.iceConnectionState)),console.log("ICE state change event: ",n))},console.log("正在启动摄像头"),navigator.mediaDevices.getUserMedia({audio:!0,video:!0}).then((function(o){n.local_stream=o;var t=n.local_stream.getVideoTracks(),c=document.getElementById("localVideo");c.srcObject=n.local_stream,console.log("Using video device: ".concat(t[0].label));var i,r=Object(s["a"])(n.local_stream.getTracks());try{for(r.s();!(i=r.n()).done;){var a=i.value;n.re_peerConnection.addTrack(a)}}catch(l){r.e(l)}finally{r.f()}console.info("setRemoteDescription ",e),n.re_peerConnection.setRemoteDescription(new RTCSessionDescription(e.sdp)),n.re_peerConnection.createAnswer({offerToReceiveAudio:!0,offerToReceiveVideo:!0}).then((function(o){n.re_peerConnection.setLocalDescription(o).then((function(){n.$socket.emit("answer",{peer:e.caller,owner:n.user_id,sdp:o})}))}))}))}},methods:{_renderChatRoom:function(){var e=this;e.user_id=this._getGuid(),e.pcOptions={optional:[{DtlsSrtpKeyAgreement:!0}]},e.configuration={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},e.$socket.emit("connect",1)},_sendChatInvitation:function(){var e=this;e.userType="productor",e.$socket.emit("chatInvitation",{user_id:e.user_id,type:e.userType})},_endChatting:function(){var e=this;e.$confirm("是否退出视频聊天？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((function(){e.userType="",e.peerConnection.close(),e.re_peerConnection.close(),e.peerConnection=null,e.re_peerConnection=null,e.$socket.emit("hangup",e.connector_id),console.log("scne hangup"),e.$socket.emit("disconnect",1);var n,o=Object(s["a"])(e.local_stream.getTracks());try{for(o.s();!(n=o.n()).done;){var t=n.value;t.stop()}}catch(c){o.e(c)}finally{o.f()}}))},_camareCtrl:function(){var e=this,n=e.local_stream.getVideoTracks();"on"==e.camare?(e.camare="off",n[0].enabled=!1):(e.camare="on",console.log(n),n[0].enabled=!0)},_audioCtrl:function(){var e=this,n=e.local_stream.getAudioTracks();"on"==e.audio?(e.audio="off",n[0].enabled=!1):(e.audio="on",n[0].enabled=!0)},_setRemoteVideo:function(e){var n=document.getElementById("remoteVideo"),o=document.getElementById("remoteAudio"),t="";e.streams&&e.streams[0]?t=e.streams[0]:(t||(t=new MediaStream),t.addTrack(e.track));var c=t.getVideoTracks();c.length&&(n.srcObject=t,n.play());var i=t.getAudioTracks();i.length&&(o.srcObject=t)},_getGuid:function(){for(var e="",n=1;n<=32;n++){var o=Math.floor(16*Math.random()).toString(16);e+=o,8!=n&&12!=n&&16!=n&&20!=n||(e+="-")}return e}}},d=l,u=(o("6186"),o("2877")),f=Object(u["a"])(d,r,a,!1,null,"5ee8c2f2",null),p=f.exports,m={name:"App",components:{webRtc:p}},_=m,v=Object(u["a"])(_,c,i,!1,null,null,null),h=v.exports,g=o("5c96"),C=o.n(g),y=(o("0fae"),o("5132")),T=o.n(y);t["default"].use(C.a),t["default"].config.productionTip=!1,new t["default"]({render:function(e){return e(h)},beforeCreate:function(){t["default"].use(new T.a({connection:"10.1.56.68:8081"}))}}).$mount("#app")},6186:function(e,n,o){"use strict";var t=o("16d8"),c=o.n(t);c.a}});